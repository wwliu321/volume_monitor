{"ast":null,"code":"var _s = $RefreshSig$();\nimport { useState, useCallback, useRef, useEffect } from 'react';\nimport { audioContextManager } from '../utils/audioContext';\nexport function useAudioMonitor({\n  threshold = 30,\n  onVolumeLow,\n  sampleInterval = 50 // 降低采样间隔以提高响应速度\n} = {}) {\n  _s();\n  const [volume, setVolume] = useState(0);\n  const [isMonitoring, setIsMonitoring] = useState(false);\n  const [error, setError] = useState(null);\n  const volumeWorker = useRef(null);\n  const animationFrameId = useRef(null);\n  const lastUpdateTime = useRef(0);\n  const updateVolume = useCallback(() => {\n    const now = Date.now();\n    if (now - lastUpdateTime.current >= sampleInterval) {\n      const currentVolume = audioContextManager.getVolume();\n      setVolume(currentVolume);\n      lastUpdateTime.current = now;\n      if (currentVolume < threshold && onVolumeLow) {\n        onVolumeLow(currentVolume);\n      }\n    }\n    animationFrameId.current = requestAnimationFrame(updateVolume);\n  }, [threshold, onVolumeLow, sampleInterval]);\n  const startMonitoring = useCallback(async () => {\n    try {\n      await audioContextManager.startMonitoring();\n      lastUpdateTime.current = Date.now();\n      updateVolume();\n      setIsMonitoring(true);\n      setError(null);\n    } catch (err) {\n      const errorMessage = err instanceof Error ? err.message : '未知错误';\n      setError(errorMessage);\n      setIsMonitoring(false);\n    }\n  }, [updateVolume]);\n  const stopMonitoring = useCallback(() => {\n    if (animationFrameId.current) {\n      cancelAnimationFrame(animationFrameId.current);\n      animationFrameId.current = null;\n    }\n    audioContextManager.stopMonitoring();\n    setIsMonitoring(false);\n  }, []);\n\n  // 组件卸载时清理\n  useEffect(() => {\n    return () => {\n      stopMonitoring();\n    };\n  }, [stopMonitoring]);\n  return {\n    volume,\n    isMonitoring,\n    error,\n    startMonitoring,\n    stopMonitoring\n  };\n}\n_s(useAudioMonitor, \"6grPODsO3vvxne8wz4RhyXb3XZY=\");","map":{"version":3,"names":["useState","useCallback","useRef","useEffect","audioContextManager","useAudioMonitor","threshold","onVolumeLow","sampleInterval","_s","volume","setVolume","isMonitoring","setIsMonitoring","error","setError","volumeWorker","animationFrameId","lastUpdateTime","updateVolume","now","Date","current","currentVolume","getVolume","requestAnimationFrame","startMonitoring","err","errorMessage","Error","message","stopMonitoring","cancelAnimationFrame"],"sources":["D:/projects/volume-monitor/src/hooks/useAudioMonitor.ts"],"sourcesContent":["import { useState, useCallback, useRef, useEffect } from 'react';\r\nimport { audioContextManager } from '../utils/audioContext';\r\nimport type { UseAudioMonitorOptions } from '../types';\r\n\r\nexport function useAudioMonitor({\r\n  threshold = 30,\r\n  onVolumeLow,\r\n  sampleInterval = 50  // 降低采样间隔以提高响应速度\r\n}: UseAudioMonitorOptions = {}) {\r\n  const [volume, setVolume] = useState<number>(0);\r\n  const [isMonitoring, setIsMonitoring] = useState<boolean>(false);\r\n  const [error, setError] = useState<string | null>(null);\r\n  \r\n  const volumeWorker = useRef<Worker | null>(null);\r\n  const animationFrameId = useRef<number | null>(null);\r\n  const lastUpdateTime = useRef<number>(0);\r\n\r\n  const updateVolume = useCallback(() => {\r\n    const now = Date.now();\r\n    if (now - lastUpdateTime.current >= sampleInterval) {\r\n      const currentVolume = audioContextManager.getVolume();\r\n      setVolume(currentVolume);\r\n      lastUpdateTime.current = now;\r\n\r\n      if (currentVolume < threshold && onVolumeLow) {\r\n        onVolumeLow(currentVolume);\r\n      }\r\n    }\r\n    \r\n    animationFrameId.current = requestAnimationFrame(updateVolume);\r\n  }, [threshold, onVolumeLow, sampleInterval]);\r\n\r\n  const startMonitoring = useCallback(async () => {\r\n    try {\r\n      await audioContextManager.startMonitoring();\r\n      lastUpdateTime.current = Date.now();\r\n      updateVolume();\r\n      setIsMonitoring(true);\r\n      setError(null);\r\n    } catch (err: unknown) {\r\n      const errorMessage = err instanceof Error ? err.message : '未知错误';\r\n      setError(errorMessage);\r\n      setIsMonitoring(false);\r\n    }\r\n  }, [updateVolume]);\r\n\r\n  const stopMonitoring = useCallback(() => {\r\n    if (animationFrameId.current) {\r\n      cancelAnimationFrame(animationFrameId.current);\r\n      animationFrameId.current = null;\r\n    }\r\n    audioContextManager.stopMonitoring();\r\n    setIsMonitoring(false);\r\n  }, []);\r\n\r\n  // 组件卸载时清理\r\n  useEffect(() => {\r\n    return () => {\r\n      stopMonitoring();\r\n    };\r\n  }, [stopMonitoring]);\r\n\r\n  return {\r\n    volume,\r\n    isMonitoring,\r\n    error,\r\n    startMonitoring,\r\n    stopMonitoring\r\n  };\r\n} "],"mappings":";AAAA,SAASA,QAAQ,EAAEC,WAAW,EAAEC,MAAM,EAAEC,SAAS,QAAQ,OAAO;AAChE,SAASC,mBAAmB,QAAQ,uBAAuB;AAG3D,OAAO,SAASC,eAAeA,CAAC;EAC9BC,SAAS,GAAG,EAAE;EACdC,WAAW;EACXC,cAAc,GAAG,EAAE,CAAE;AACC,CAAC,GAAG,CAAC,CAAC,EAAE;EAAAC,EAAA;EAC9B,MAAM,CAACC,MAAM,EAAEC,SAAS,CAAC,GAAGX,QAAQ,CAAS,CAAC,CAAC;EAC/C,MAAM,CAACY,YAAY,EAAEC,eAAe,CAAC,GAAGb,QAAQ,CAAU,KAAK,CAAC;EAChE,MAAM,CAACc,KAAK,EAAEC,QAAQ,CAAC,GAAGf,QAAQ,CAAgB,IAAI,CAAC;EAEvD,MAAMgB,YAAY,GAAGd,MAAM,CAAgB,IAAI,CAAC;EAChD,MAAMe,gBAAgB,GAAGf,MAAM,CAAgB,IAAI,CAAC;EACpD,MAAMgB,cAAc,GAAGhB,MAAM,CAAS,CAAC,CAAC;EAExC,MAAMiB,YAAY,GAAGlB,WAAW,CAAC,MAAM;IACrC,MAAMmB,GAAG,GAAGC,IAAI,CAACD,GAAG,CAAC,CAAC;IACtB,IAAIA,GAAG,GAAGF,cAAc,CAACI,OAAO,IAAId,cAAc,EAAE;MAClD,MAAMe,aAAa,GAAGnB,mBAAmB,CAACoB,SAAS,CAAC,CAAC;MACrDb,SAAS,CAACY,aAAa,CAAC;MACxBL,cAAc,CAACI,OAAO,GAAGF,GAAG;MAE5B,IAAIG,aAAa,GAAGjB,SAAS,IAAIC,WAAW,EAAE;QAC5CA,WAAW,CAACgB,aAAa,CAAC;MAC5B;IACF;IAEAN,gBAAgB,CAACK,OAAO,GAAGG,qBAAqB,CAACN,YAAY,CAAC;EAChE,CAAC,EAAE,CAACb,SAAS,EAAEC,WAAW,EAAEC,cAAc,CAAC,CAAC;EAE5C,MAAMkB,eAAe,GAAGzB,WAAW,CAAC,YAAY;IAC9C,IAAI;MACF,MAAMG,mBAAmB,CAACsB,eAAe,CAAC,CAAC;MAC3CR,cAAc,CAACI,OAAO,GAAGD,IAAI,CAACD,GAAG,CAAC,CAAC;MACnCD,YAAY,CAAC,CAAC;MACdN,eAAe,CAAC,IAAI,CAAC;MACrBE,QAAQ,CAAC,IAAI,CAAC;IAChB,CAAC,CAAC,OAAOY,GAAY,EAAE;MACrB,MAAMC,YAAY,GAAGD,GAAG,YAAYE,KAAK,GAAGF,GAAG,CAACG,OAAO,GAAG,MAAM;MAChEf,QAAQ,CAACa,YAAY,CAAC;MACtBf,eAAe,CAAC,KAAK,CAAC;IACxB;EACF,CAAC,EAAE,CAACM,YAAY,CAAC,CAAC;EAElB,MAAMY,cAAc,GAAG9B,WAAW,CAAC,MAAM;IACvC,IAAIgB,gBAAgB,CAACK,OAAO,EAAE;MAC5BU,oBAAoB,CAACf,gBAAgB,CAACK,OAAO,CAAC;MAC9CL,gBAAgB,CAACK,OAAO,GAAG,IAAI;IACjC;IACAlB,mBAAmB,CAAC2B,cAAc,CAAC,CAAC;IACpClB,eAAe,CAAC,KAAK,CAAC;EACxB,CAAC,EAAE,EAAE,CAAC;;EAEN;EACAV,SAAS,CAAC,MAAM;IACd,OAAO,MAAM;MACX4B,cAAc,CAAC,CAAC;IAClB,CAAC;EACH,CAAC,EAAE,CAACA,cAAc,CAAC,CAAC;EAEpB,OAAO;IACLrB,MAAM;IACNE,YAAY;IACZE,KAAK;IACLY,eAAe;IACfK;EACF,CAAC;AACH;AAACtB,EAAA,CAjEeJ,eAAe","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}