{"ast":null,"code":"export class AudioContextManager {\n  constructor() {\n    this.audioContext = null;\n    this.mediaStream = null;\n    this.analyser = null;\n    this.dataArray = null;\n    this.isInitialized = false;\n    this.initializationPromise = null;\n    this.eventListeners = [];\n    this.isProcessingUserInteraction = false;\n    this.addUserInteractionListener();\n  }\n  addUserInteractionListener() {\n    const userInteractionEvents = ['click', 'touchstart', 'keydown'];\n    const handler = async event => {\n      if (this.isProcessingUserInteraction) return;\n      this.isProcessingUserInteraction = true;\n      try {\n        if (this.audioContext) {\n          await this.audioContext.resume();\n        }\n        // 成功处理后移除所有监听器\n        this.removeAllEventListeners();\n      } catch (error) {\n        console.error('Error handling user interaction:', error);\n      } finally {\n        this.isProcessingUserInteraction = false;\n      }\n    };\n    userInteractionEvents.forEach(eventType => {\n      const boundHandler = handler.bind(this);\n      document.addEventListener(eventType, boundHandler);\n      this.eventListeners.push({\n        type: eventType,\n        listener: boundHandler\n      });\n    });\n  }\n  removeAllEventListeners() {\n    this.eventListeners.forEach(({\n      type,\n      listener\n    }) => {\n      document.removeEventListener(type, listener);\n    });\n    this.eventListeners = [];\n  }\n  async initialize() {\n    if (this.initializationPromise) {\n      return this.initializationPromise;\n    }\n    this.initializationPromise = new Promise(async (resolve, reject) => {\n      try {\n        if (!this.audioContext) {\n          this.audioContext = new (window.AudioContext || window.webkitAudioContext)();\n        }\n        if (this.audioContext.state !== 'running') {\n          await this.audioContext.resume();\n        }\n        this.mediaStream = await navigator.mediaDevices.getUserMedia({\n          audio: {\n            echoCancellation: true,\n            noiseSuppression: true,\n            autoGainControl: true\n          },\n          video: false\n        });\n        const source = this.audioContext.createMediaStreamSource(this.mediaStream);\n        this.analyser = this.audioContext.createAnalyser();\n        this.analyser.fftSize = 2048;\n        source.connect(this.analyser);\n        this.dataArray = new Uint8Array(this.analyser.frequencyBinCount);\n        this.isInitialized = true;\n        resolve();\n      } catch (error) {\n        this.cleanup();\n        reject(error);\n      }\n    });\n    return this.initializationPromise;\n  }\n  cleanup() {\n    this.removeAllEventListeners();\n    if (this.mediaStream) {\n      this.mediaStream.getTracks().forEach(track => track.stop());\n      this.mediaStream = null;\n    }\n    if (this.analyser) {\n      this.analyser.disconnect();\n      this.analyser = null;\n    }\n    if (this.audioContext) {\n      this.audioContext.close().catch(console.error);\n      this.audioContext = null;\n    }\n    this.dataArray = null;\n    this.isInitialized = false;\n    this.initializationPromise = null;\n  }\n  async startMonitoring() {\n    try {\n      // 添加用户提示\n      console.log('请点击页面任意位置以启动音频监控');\n      await this.initialize();\n    } catch (error) {\n      this.cleanup();\n      throw new Error('Failed to initialize audio context: ' + error.message);\n    }\n  }\n  stopMonitoring() {\n    this.cleanup();\n  }\n  getVolume() {\n    if (!this.analyser || !this.dataArray || !this.isInitialized) {\n      return 0;\n    }\n    try {\n      // 获取音频数据\n      this.analyser.getByteFrequencyData(this.dataArray);\n\n      // 计算平均音量\n      const average = this.dataArray.reduce((acc, value) => acc + value, 0) / this.dataArray.length;\n\n      // 将音量值映射到 0-100 范围\n      return Math.min(Math.round(average / 255 * 100), 100);\n    } catch (error) {\n      console.error('Error getting volume:', error);\n      return 0;\n    }\n  }\n  isActive() {\n    return this.isInitialized && this.audioContext !== null && this.audioContext.state === 'running';\n  }\n}\nexport const audioContextManager = new AudioContextManager();","map":{"version":3,"names":["AudioContextManager","constructor","audioContext","mediaStream","analyser","dataArray","isInitialized","initializationPromise","eventListeners","isProcessingUserInteraction","addUserInteractionListener","userInteractionEvents","handler","event","resume","removeAllEventListeners","error","console","forEach","eventType","boundHandler","bind","document","addEventListener","push","type","listener","removeEventListener","initialize","Promise","resolve","reject","window","AudioContext","webkitAudioContext","state","navigator","mediaDevices","getUserMedia","audio","echoCancellation","noiseSuppression","autoGainControl","video","source","createMediaStreamSource","createAnalyser","fftSize","connect","Uint8Array","frequencyBinCount","cleanup","getTracks","track","stop","disconnect","close","catch","startMonitoring","log","Error","message","stopMonitoring","getVolume","getByteFrequencyData","average","reduce","acc","value","length","Math","min","round","isActive","audioContextManager"],"sources":["D:/projects/volume-monitor/src/utils/audioContext.ts"],"sourcesContent":["export class AudioContextManager {\r\n  private audioContext: AudioContext | null = null;\r\n  private mediaStream: MediaStream | null = null;\r\n  private analyser: AnalyserNode | null = null;\r\n  private dataArray: Uint8Array | null = null;\r\n  private isInitialized: boolean = false;\r\n  private initializationPromise: Promise<void> | null = null;\r\n  private eventListeners: { type: string; listener: EventListener }[] = [];\r\n  private isProcessingUserInteraction: boolean = false;\r\n\r\n  constructor() {\r\n    this.addUserInteractionListener();\r\n  }\r\n\r\n  private addUserInteractionListener() {\r\n    const userInteractionEvents = ['click', 'touchstart', 'keydown'];\r\n    const handler = async (event: Event) => {\r\n      if (this.isProcessingUserInteraction) return;\r\n      this.isProcessingUserInteraction = true;\r\n\r\n      try {\r\n        if (this.audioContext) {\r\n          await this.audioContext.resume();\r\n        }\r\n        // 成功处理后移除所有监听器\r\n        this.removeAllEventListeners();\r\n      } catch (error) {\r\n        console.error('Error handling user interaction:', error);\r\n      } finally {\r\n        this.isProcessingUserInteraction = false;\r\n      }\r\n    };\r\n\r\n    userInteractionEvents.forEach(eventType => {\r\n      const boundHandler = handler.bind(this);\r\n      document.addEventListener(eventType, boundHandler);\r\n      this.eventListeners.push({ type: eventType, listener: boundHandler });\r\n    });\r\n  }\r\n\r\n  private removeAllEventListeners() {\r\n    this.eventListeners.forEach(({ type, listener }) => {\r\n      document.removeEventListener(type, listener);\r\n    });\r\n    this.eventListeners = [];\r\n  }\r\n\r\n  private async initialize() {\r\n    if (this.initializationPromise) {\r\n      return this.initializationPromise;\r\n    }\r\n\r\n    this.initializationPromise = new Promise<void>(async (resolve, reject) => {\r\n      try {\r\n        if (!this.audioContext) {\r\n          this.audioContext = new (window.AudioContext || (window as any).webkitAudioContext)();\r\n        }\r\n\r\n        if (this.audioContext.state !== 'running') {\r\n          await this.audioContext.resume();\r\n        }\r\n\r\n        this.mediaStream = await navigator.mediaDevices.getUserMedia({\r\n          audio: {\r\n            echoCancellation: true,\r\n            noiseSuppression: true,\r\n            autoGainControl: true\r\n          },\r\n          video: false\r\n        });\r\n\r\n        const source = this.audioContext.createMediaStreamSource(this.mediaStream);\r\n        this.analyser = this.audioContext.createAnalyser();\r\n        this.analyser.fftSize = 2048;\r\n        source.connect(this.analyser);\r\n        this.dataArray = new Uint8Array(this.analyser.frequencyBinCount);\r\n        \r\n        this.isInitialized = true;\r\n        resolve();\r\n      } catch (error) {\r\n        this.cleanup();\r\n        reject(error);\r\n      }\r\n    });\r\n\r\n    return this.initializationPromise;\r\n  }\r\n\r\n  private cleanup() {\r\n    this.removeAllEventListeners();\r\n    \r\n    if (this.mediaStream) {\r\n      this.mediaStream.getTracks().forEach(track => track.stop());\r\n      this.mediaStream = null;\r\n    }\r\n    if (this.analyser) {\r\n      this.analyser.disconnect();\r\n      this.analyser = null;\r\n    }\r\n    if (this.audioContext) {\r\n      this.audioContext.close().catch(console.error);\r\n      this.audioContext = null;\r\n    }\r\n    this.dataArray = null;\r\n    this.isInitialized = false;\r\n    this.initializationPromise = null;\r\n  }\r\n\r\n  async startMonitoring() {\r\n    try {\r\n      // 添加用户提示\r\n      console.log('请点击页面任意位置以启动音频监控');\r\n      await this.initialize();\r\n    } catch (error) {\r\n      this.cleanup();\r\n      throw new Error('Failed to initialize audio context: ' + (error as Error).message);\r\n    }\r\n  }\r\n\r\n  stopMonitoring() {\r\n    this.cleanup();\r\n  }\r\n\r\n  getVolume(): number {\r\n    if (!this.analyser || !this.dataArray || !this.isInitialized) {\r\n      return 0;\r\n    }\r\n\r\n    try {\r\n      // 获取音频数据\r\n      this.analyser.getByteFrequencyData(this.dataArray);\r\n\r\n      // 计算平均音量\r\n      const average = this.dataArray.reduce((acc, value) => acc + value, 0) / this.dataArray.length;\r\n      \r\n      // 将音量值映射到 0-100 范围\r\n      return Math.min(Math.round((average / 255) * 100), 100);\r\n    } catch (error) {\r\n      console.error('Error getting volume:', error);\r\n      return 0;\r\n    }\r\n  }\r\n\r\n  isActive(): boolean {\r\n    return this.isInitialized && this.audioContext !== null && this.audioContext.state === 'running';\r\n  }\r\n}\r\n\r\nexport const audioContextManager = new AudioContextManager(); "],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}